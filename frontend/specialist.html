<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Specialist Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* General Styles */
        body {
            font-family: 'Rubik', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            color: #333;
        }

        /* Header Styling */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: #01579B;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .header h1 {
            margin: 0;
            font-size: 22px;
        }

        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: #c0392b;
        }

        /* Sidebar Styling */
        .sidebar {
            width: 250px;
            background: #0277BD;
            color: white;
            padding: 20px;
            height: calc(100vh - 60px);
            position: fixed;
            top: 60px;
            left: 0;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.2);
        }

        .sidebar h2 {
            font-size: 18px;
            margin-bottom: 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            padding-bottom: 5px;
        }

        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar-menu li {
            margin-bottom: 10px;
        }

        .sidebar-menu a {
            display: block;
            color: white;
            text-decoration: none;
            padding: 10px;
            border-radius: 5px;
            transition: background 0.3s;
        }

        .sidebar-menu a:hover,
        .sidebar-menu a.active {
            background: rgba(255, 255, 255, 0.2);
        }

        .sidebar-menu i {
            margin-right: 10px;
        }

        /* Main Content */
        .main-content {
            margin-left: 270px;
            padding: 80px 20px 20px;
        }

        /* Profile Photo */
        .profile-photo {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            display: block;
            margin: 10px auto;
            object-fit: cover;
            border: 3px solid white;
        }

        /* Section Styles */
        .section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .section h2 {
            margin-top: 0;
            color: #2c3e50;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        /* Forms */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        /* Buttons */
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }

        .btn-primary {
            background: #01579B;
            color: white;
        }

        .btn-primary:hover {
            background: #013f6b;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        /* Table Styles */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .data-table th,
        .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .data-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #2c3e50;
        }

        .data-table tr:hover {
            background-color: #f5f5f5;
        }

        /* Action Buttons */
        .action-btn {
            padding: 5px 10px;
            margin-right: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .edit-btn {
            background: #3498db;
            color: white;
        }

        .delete-btn {
            background: #e74c3c;
            color: white;
        }

        .view-btn {
            background: #2ecc71;
            color: white;
        }

        .action-btn:hover {
            opacity: 0.8;
        }

        /* Status Badges */
        .badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-primary {
            background: #cce5ff;
            color: #004085;
        }

        /* Reviews Section */
        .reviews-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }

        .review-card {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 8px;
            background: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .review-client {
            font-weight: bold;
            color: #01579B;
        }

        .review-rating {
            color: gold;
            font-weight: bold;
        }

        .review-content {
            color: #555;
            line-height: 1.5;
        }

        .star-rating {
            color: gold;
            font-size: 18px;
            margin-right: 5px;
        }

        /* Previous Works Gallery */
        .previous-works-gallery {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
        }

        .work-card {
            width: 150px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
        }

        .work-card img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        /* Chat Section */
        #chatIcon {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #01579B;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            font-size: 20px;
        }

        .chat-container {
            display: flex;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            height: 500px;
        }

        .chat-users {
            width: 30%;
            background: #f8f9fa;
            padding: 15px;
            overflow-y: auto;
            border-right: 1px solid #ddd;
        }

        .chat-users h3 {
            margin-top: 0;
            color: #2c3e50;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }

        .chat-users ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .chat-users li {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: background 0.3s;
        }

        .chat-users li:hover {
            background: #e9ecef;
        }

        .chat-box {
            width: 70%;
            display: flex;
            flex-direction: column;
            padding: 15px;
        }

        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message {
            padding: 10px 15px;
            border-radius: 8px;
            max-width: 70%;
            position: relative;
        }

        .sent {
            background: #01579B;
            color: white;
            align-self: flex-end;
        }

        .received {
            background: #e9ecef;
            color: #333;
            align-self: flex-start;
        }

        .timestamp {
            font-size: 11px;
            color: #6c757d;
            display: block;
            margin-top: 5px;
        }

        .sent .timestamp {
            color: rgba(255, 255, 255, 0.7);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                top: 0;
            }

            .main-content {
                margin-left: 0;
                padding: 20px;
            }
        }

        /* Verification Section Styles */



        /* Ensure main content doesn't overlap with sidebar */
        /* Verification Section Styles */
        .verification-images {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .verification-image-container {
            flex: 1;
            border: 1px dashed #ddd;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .verification-image-preview {
            max-width: 100%;
            max-height: 300px;
            margin-bottom: 10px;
            border: 1px solid #eee;
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .alert-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .alert-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert i {
            margin-right: 10px;
        }


        .main-content {
            margin-left: 270px;
            padding: 80px 20px 20px;
            min-height: calc(100vh - 60px);
            box-sizing: border-box;
        }

        @media (max-width: 768px) {
            .main-content {
                margin-left: 0;
                padding: 20px;
            }

            .verification-images {
                flex-direction: column;
            }
        }

        /* Add to your CSS */
        .verified-badge {
            color: #28a745;
            margin-left: 5px;
            font-size: 16px;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<body>
    <!-- Header -->
    <div class="header">
        <h1>Specialist Dashboard</h1>
        <button class="logout-btn" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i> Logout
        </button>
    </div>

    <!-- Sidebar -->
    <div class="sidebar">
        <h2>Welcome, <span id="specialist-name">Specialist</span></h2>
        <img id="profile-photo" class="profile-photo" src="default.jpg" alt="Profile Photo">

        <ul class="sidebar-menu">
            <li><a href="#" onclick="showSection('view-profile')" class="active"><i class="fas fa-user"></i> View
                    Profile</a></li>
            <li><a href="#" onclick="showSection('edit-profile')"><i class="fas fa-edit"></i> Edit Profile</a></li>
            <li><a href="#" onclick="showSection('previous-works')"><i class="fas fa-images"></i> Previous Works</a>
            </li>
            <li><a href="#" onclick="showSection('availability-section')"><i class="fas fa-calendar-check"></i>
                    Availability</a></li>
            <li><a href="#" onclick="showSection('bookings-section')"><i class="fas fa-calendar-alt"></i> Bookings</a>
            </li>
            <li><a href="#" onclick="showSection('reviews-section'); fetchReviews();"><i class="fas fa-star"></i> Client
                    Reviews</a></li>
            <li><a href="#" onclick="showSection('chats-section')"><i class="fas fa-comments"></i> Messages</a></li>
            <!-- Add this to the sidebar menu in admin.html -->
            <li><a href="#" onclick="showSection('verification-section')"><i class="fas fa-id-card"></i>
                    Verifications</a></li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Edit Profile Section -->
        <div id="edit-profile" class="section" style="display: none;">
            <h2>Edit Profile</h2>

            <div class="form-group">
                <label for="profile-upload">Upload Profile Photo:</label>
                <input type="file" id="profile-upload" class="form-control" accept="image/*">
            </div>

            <div class="form-group">
                <label>Select Services:</label>
                <div style="display: flex; gap: 15px;">
                    <div>
                        <input type="checkbox" id="pedicure" value="Pedicure">
                        <label for="pedicure">Pedicure</label>
                    </div>
                    <div>
                        <input type="checkbox" id="manicure" value="Manicure">
                        <label for="manicure">Manicure</label>
                    </div>
                    <div>
                        <input type="checkbox" id="makeup" value="Makeup">
                        <label for="makeup">Makeup</label>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="specialist-experience">Years of Experience</label>
                <input type="number" id="specialist-experience" class="form-control"
                    placeholder="Enter years of experience">
            </div>

            <div class="form-group">
                <label for="specialist-skills">Skills</label>
                <textarea id="specialist-skills" class="form-control" placeholder="Describe your skills"></textarea>
            </div>

            <div class="form-actions">
                <button class="btn btn-primary" onclick="updateProfile()">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </div>

        <!-- View Profile Section -->
        <div id="view-profile" class="section">
            <h2>View Profile</h2>
            <img id="view-profile-photo" class="profile-photo" src="default.jpg" alt="Profile Photo">

            <table class="data-table">
                <tbody>

                    <tr>
                        <td><strong>Status:</strong></td>
                        <td>
                            <span id="view-specialist-status" class="badge"></span>
                            <span id="verification-badge" class="verified-badge" style="display: none;">
                                <i class="fas fa-check-circle"></i> Verified
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Full Name:</strong></td>
                        <td><span id="view-specialist-name"></span></td>
                    </tr>
                    <tr>
                        <td><strong>Email:</strong></td>
                        <td><span id="view-specialist-email"></span></td>
                    </tr>
                    <tr>
                        <td><strong>Phone:</strong></td>
                        <td><span id="view-specialist-phone"></span></td>
                    </tr>
                    <tr>
                        <td><strong>Gender:</strong></td>
                        <td><span id="view-specialist-gender"></span></td>
                    </tr>
                    <tr>
                        <td><strong>Location:</strong></td>
                        <td><span id="view-specialist-location"></span></td>
                    </tr>
                    <tr>
                        <td><strong>Role:</strong></td>
                        <td><span id="view-specialist-role"></span></td>
                    </tr>
                    <tr>
                        <td><strong>Services:</strong></td>
                        <td><span id="view-specialist-services"></span></td>
                    </tr>
                    <tr>
                        <td><strong>Experience:</strong></td>
                        <td><span id="view-specialist-experience"></span></td>
                    </tr>
                    <tr>
                        <td><strong>Skills:</strong></td>
                        <td><span id="view-specialist-skills"></span></td>
                    </tr>
                </tbody>
            </table>

            <div class="form-actions">
                <button class="btn btn-primary" onclick="showSection('edit-profile')">
                    <i class="fas fa-edit"></i> Edit Profile
                </button>
            </div>
        </div>

        <!-- Previous Works Section -->
        <div id="previous-works" class="section" style="display: none;">
            <h2>Previous Works</h2>

            <form id="previousWorksForm" enctype="multipart/form-data" class="form-group">
                <label for="previous-work">Upload a Work:</label>
                <input type="file" id="previous-work" class="form-control" accept="image/*" required>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-upload"></i> Upload Photo
                </button>
            </form>

            <div id="message" class="form-group"></div>

            <h3>Uploaded Works</h3>
            <div id="previous-works-gallery" class="previous-works-gallery">
                <!-- Works will be loaded here -->
            </div>
        </div>

        <!-- Availability Section -->
        <div id="availability-section" class="section" style="display: none;">
            <h2>Confirm Availability</h2>

            <div class="form-group">
                <label for="availability-status">Set Availability:</label>
                <select id="availability-status" class="form-control">
                    <option value="available">Available</option>
                    <option value="not_available">Not Available</option>
                </select>
            </div>

            <div class="form-actions">
                <button class="btn btn-primary" onclick="updateAvailability()">
                    <i class="fas fa-save"></i> Save Availability
                </button>
            </div>

            <h3>Today's Sessions</h3>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="session-list">
                    <!-- Sessions will be loaded here -->
                </tbody>
            </table>
        </div>
        <!-- Bookings Section -->
        <div id="bookings-section" class="section" style="display: none;">
            <h2>Bookings</h2>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Client</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="bookings-list">
                    <!-- Bookings will be loaded here -->
                </tbody>
            </table>
        </div>
        <!-- Reviews Section -->
        <div id="reviews-section" class="section" style="display: none;">
            <h2>Client Reviews</h2>
            <div class="rating-summary">
                <div class="average-rating">
                    <span class="rating-value" id="averageRating">0.0</span>
                    <div class="stars" id="averageStars"></div>
                    <span class="review-count" id="reviewCount">(0 reviews)</span>
                </div>
            </div>
            <div id="reviewsList" class="reviews-container">
                <!-- Reviews will be loaded here -->
            </div>
        </div>

        <!-- Chats Section -->
        <div id="chats-section" class="section" style="display: none;">
            <h2>Chats</h2>
            <div class="chat-container">
                <!-- Left Side: List of Clients -->
                <div class="chat-users">
                    <h3>Clients</h3>
                    <ul id="chatList"></ul>
                </div>

                <!-- Right Side: Chat Messages & Input -->
                <div class="chat-box">
                    <h3>Chat with <span id="chatClientName">Select a client</span></h3>
                    <div id="chatMessages" class="chat-messages"></div>
                    <div class="form-group">
                        <textarea id="chatInput" class="form-control" placeholder="Type a message..."></textarea>
                        <button class="btn btn-primary" onclick="sendMessage()">
                            <i class="fas fa-paper-plane"></i> Send
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Floating Chat Icon -->
        <div id="chatIcon" onclick="openChatList()">
            <i class="fas fa-comment"></i>
            <span id="unreadCount" class="badge badge-danger"
                style="position: absolute; top: -5px; right: -5px;">0</span>
        </div>
        <div id="verification-section" class="section" style="display: none;">
            <h2>Account Verification</h2>

            <div id="verification-status" class="alert alert-info">
                <i class="fas fa-info-circle"></i> Loading verification status...
            </div>

            <div id="verification-form">
                <div class="form-group">
                    <h3>Upload Verification Documents</h3>
                    <p>Please upload clear photos of your national ID or passport (both front and back sides)</p>
                </div>

                <div class="verification-images">
                    <div class="verification-image-container">
                        <label for="front-image">Front Side</label>
                        <img id="front-image-preview" src="" class="verification-image-preview" style="display: none;">
                        <input type="file" id="front-image" class="form-control" accept="image/*" required
                            onchange="previewImage(this, 'front-image-preview')">
                    </div>

                    <div class="verification-image-container">
                        <label for="back-image">Back Side</label>
                        <img id="back-image-preview" src="" class="verification-image-preview" style="display: none;">
                        <input type="file" id="back-image" class="form-control" accept="image/*" required
                            onchange="previewImage(this, 'back-image-preview')">
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-primary" onclick="submitVerification()">
                        <i class="fas fa-upload"></i> Submit for Verification
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Verification Section -->


    <script>
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(sectionId).style.display = 'block';

            if (sectionId === 'availability-section') {
                fetchSessions();
            } else if (sectionId === 'bookings-section') {
                fetchBookings();
            } else if (sectionId === 'previous-works') {
                fetchPreviousWorks();
            } else if (sectionId === 'chats-section') {
                fetchChatList();
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            showSection("view-profile");
            fetchSpecialistDetails();
        });

        function getSelectedServices() {
            let selected = [];
            document.querySelectorAll('input[type="checkbox"]:checked').forEach((checkbox) => {
                selected.push(checkbox.value);
            });
            return selected.join(", ");
        }

        async function updateProfile() {
            const formData = new FormData();
            formData.append("profile_photo", document.getElementById("profile-upload").files[0]);
            formData.append("services", getSelectedServices());
            formData.append("experience", document.getElementById("specialist-experience").value);
            formData.append("skills", document.getElementById("specialist-skills").value);

            try {
                const response = await fetch("http://localhost:8080/api/specialist/update-profile", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${localStorage.getItem("token")}` },
                    body: formData
                });

                const result = await response.json();
                if (response.ok) {
                    alert(result.message);
                    fetchSpecialistDetails();
                    showSection("view-profile");
                } else {
                    alert(result.error || "Profile update failed.");
                }
            } catch (error) {
                console.error("Error updating profile:", error);
            }
        }
        async function fetchSpecialistDetails() {
            try {
                const response = await fetch("http://localhost:8080/api/specialist/details", {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${localStorage.getItem("token")}`
                    }
                });

                const result = await response.json();

                if (response.ok) {
                    // Update basic profile information
                    document.getElementById("specialist-name").innerText = result.full_name;
                    document.getElementById("view-specialist-name").innerText = result.full_name;
                    document.getElementById("view-specialist-email").innerText = result.email;
                    document.getElementById("view-specialist-phone").innerText = result.phone;
                    document.getElementById("view-specialist-gender").innerText = result.gender;
                    document.getElementById("view-specialist-location").innerText = result.location;
                    document.getElementById("view-specialist-role").innerText = result.role;
                    document.getElementById("view-specialist-services").innerText = result.services || "Not set";
                    document.getElementById("view-specialist-experience").innerText = result.experience !== "Not set" ? `${result.experience} years` : "Not set";
                    document.getElementById("view-specialist-skills").innerText = result.skills || "Not set";

                    // Update profile photo if available
                    if (result.profile_photo) {
                        document.getElementById("profile-photo").src = result.profile_photo;
                        document.getElementById("view-profile-photo").src = result.profile_photo;
                    }

                    // Update verification status display
                    const statusElement = document.getElementById("view-specialist-status");
                    const badgeElement = document.getElementById("verification-badge");

                    // Use the verification_status from the response
                    const verificationStatus = result.verification_status || 'not_submitted';

                    if (verificationStatus === 'approved') {
                        statusElement.innerHTML = '<span class="badge badge-success">Verified</span>';
                        badgeElement.style.display = "inline";
                    } else if (verificationStatus === 'pending') {
                        statusElement.innerHTML = '<span class="badge badge-warning">Pending Verification</span>';
                        badgeElement.style.display = "none";
                    } else if (verificationStatus === 'rejected') {
                        statusElement.innerHTML = '<span class="badge badge-danger">Verification Rejected</span>';
                        badgeElement.style.display = "none";
                    } else {
                        statusElement.innerHTML = '<span class="badge badge-danger">Not Verified</span>';
                        badgeElement.style.display = "none";
                    }
                } else {
                    alert(result.error || "Failed to load specialist details.");
                }
            } catch (error) {
                console.error("Error fetching specialist details:", error);
            }
        }
        // New function to update verification status display in profile
        async function updateVerificationStatusDisplay() {
            try {
                const response = await fetch("http://localhost:8080/api/specialist/verification-status-only", {
                    headers: {
                        "Authorization": `Bearer ${localStorage.getItem("token")}`
                    }
                });

                const statusData = await response.json();
                const statusElement = document.getElementById("view-specialist-status");
                const badgeElement = document.getElementById("verification-badge");

                // Determine verification status text and styling
                let statusText = "Not Submitted";
                let badgeClass = "badge-danger";

                if (statusData.status === 'pending') {
                    statusText = "Pending Verification";
                    badgeClass = "badge-warning";
                } else if (statusData.status === 'approved') {
                    statusText = "Verified";
                    badgeClass = "badge-success";
                    badgeElement.style.display = "inline";
                } else if (statusData.status === 'rejected') {
                    statusText = "Verification Rejected";
                    badgeClass = "badge-danger";
                    if (statusData.rejection_reason) {
                        statusText += `: ${statusData.rejection_reason}`;
                    }
                }

                // Update the status display
                statusElement.innerHTML = `<span class="badge ${badgeClass}">${statusText}</span>`;
                badgeElement.style.display = statusData.status === 'approved' ? "inline" : "none";

            } catch (error) {
                console.error("Error updating verification status display:", error);
                document.getElementById("view-specialist-status").innerHTML =
                    '<span class="badge badge-danger">Status Error</span>';
            }
        }

        // Update DOMContentLoaded to include the new function
        document.addEventListener("DOMContentLoaded", () => {
            showSection("view-profile");
            fetchSpecialistDetails();
            checkVerificationStatus();
            fetchReviews();
            fetchAverageRating();
            setInterval(fetchUnreadMessagesCount, 10000);
        });


        async function fetchSessions() {
            try {
                const response = await fetch("http://localhost:8080/api/specialist/sessions", {
                    headers: { "Authorization": `Bearer ${localStorage.getItem("token")}` }
                });

                const data = await response.json();
                const sessionsList = document.getElementById("session-list");
                sessionsList.innerHTML = ""; // Clear existing content

                if (data.sessions && data.sessions.length > 0) {
                    // If sessions exist, disable the "Available" option
                    const availabilityStatus = document.getElementById("availability-status");
                    availabilityStatus.querySelector('option[value="available"]').disabled = true;

                    // Display sessions
                    sessionsList.innerHTML = data.sessions.map(session => `
                        <tr>
                            <td>${session.start_time} to ${session.end_time}</td>
                            <td><span class="badge ${session.status === 'confirmed' ? 'badge-success' : 'badge-warning'}">${session.status}</span></td>
                        </tr>
                    `).join("");
                } else {
                    sessionsList.innerHTML = "<tr><td colspan='2'>No sessions scheduled for today.</td></tr>";
                }
            } catch (error) {
                console.error("Error fetching sessions:", error);
            }
        }

        async function updateAvailability() {
            const availabilityStatus = document.getElementById("availability-status").value;

            try {
                const response = await fetch("http://localhost:8080/api/specialist/update-availability", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${localStorage.getItem("token")}`
                    },
                    body: JSON.stringify({ status: availabilityStatus })
                });

                const result = await response.json();
                if (response.ok) {
                    alert(result.message);
                    fetchSessions(); // Refresh the sessions list
                } else {
                    alert(result.error || "Failed to update availability.");
                }
            } catch (error) {
                console.error("Error updating availability:", error);
            }
        }

        async function fetchBookings() {
            try {
                const response = await fetch("http://localhost:8080/api/specialist/bookings", {
                    headers: { "Authorization": `Bearer ${localStorage.getItem("token")}` }
                });

                const data = await response.json();
                const bookingsList = document.getElementById("bookings-list");
                bookingsList.innerHTML = "";

                if (data.bookings && data.bookings.length > 0) {
                    bookingsList.innerHTML = data.bookings.map(booking => `
                <tr>
                    <td>${booking.date}</td>
                    <td>${booking.start_time} to ${booking.end_time}</td>
                    <td>${booking.client_name}</td>
                    <td>${booking.client_email}</td>
                    <td>${booking.client_phone}</td>
                    <td>
                        <span class="badge ${getStatusBadgeClass(booking.booking_status)}">
                            ${booking.booking_status || 'N/A'}
                        </span>
                    </td>
                    <td>
                        ${booking.booking_status === 'pending' ? `
                        <button class="action-btn edit-btn" onclick="acceptBooking(${booking.booking_id})">
                            <i class="fas fa-check"></i> Accept
                        </button>
                        <button class="action-btn delete-btn" onclick="rejectBooking(${booking.booking_id})">
                            <i class="fas fa-times"></i> Reject
                        </button>
                        ` : ''}
                    </td>
                </tr>
            `).join("");
                } else {
                    bookingsList.innerHTML = "<tr><td colspan='7'>No upcoming bookings.</td></tr>";
                }
            } catch (error) {
                console.error("Error fetching bookings:", error);
            }
        }

        // Helper function to determine badge class based on status
        function getStatusBadgeClass(status) {
            switch (status) {
                case 'accepted': return 'badge-success';
                case 'pending': return 'badge-warning';
                case 'rejected': return 'badge-danger';
                default: return 'badge-primary';
            }
        }
        document.getElementById("previousWorksForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const formData = new FormData();
            const fileInput = document.getElementById("previous-work").files[0];

            if (!fileInput) {
                alert("Please select a file.");
                return;
            }

            formData.append("previous-work", fileInput);

            try {
                const response = await fetch("http://localhost:8080/api/specialist/upload-previous-work", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${localStorage.getItem("token")}` },
                    body: formData,
                });

                const result = await response.json();
                document.getElementById("message").innerText = result.message || result.error;

                if (response.ok) fetchPreviousWorks(); // Reload previous works after upload
            } catch (error) {
                console.error("Error uploading previous work:", error);
                document.getElementById("message").innerText = "Upload failed.";
            }
        });

        async function fetchPreviousWorks() {
            try {
                const response = await fetch("http://localhost:8080/api/specialist/get-previous-works", {
                    headers: { "Authorization": `Bearer ${localStorage.getItem("token")}` }
                });

                const works = await response.json();
                const gallery = document.getElementById("previous-works-gallery");
                gallery.innerHTML = ""; // Clear previous content

                if (works.length === 0) {
                    gallery.innerHTML = "<p>No previous works uploaded.</p>";
                    return;
                }

                works.forEach((work) => {
                    const workWrapper = document.createElement("div");
                    workWrapper.classList.add("work-card");

                    workWrapper.innerHTML = `
                        <img src="http://localhost:8080${work.image_path}" alt="Previous work">
                        <input type="number" class="form-control" value="${work.price || ""}" placeholder="Enter price">
                        <button class="btn btn-primary" style="margin-top: 5px;" onclick="savePrice(${work.id}, this.previousElementSibling.value)">
                            <i class="fas fa-save"></i> Save Price
                        </button>
                        <button class="btn btn-danger" style="margin-top: 5px;" onclick="deletePreviousWork(${work.id})">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    `;
                    gallery.appendChild(workWrapper);
                });
            } catch (error) {
                console.error("Error fetching previous works:", error);
            }
        }

        async function savePrice(workId, price) {
            await fetch(`http://localhost:8080/api/specialist/update-work-price/${workId}`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${localStorage.getItem("token")}`
                },
                body: JSON.stringify({ price })
            });
            fetchPreviousWorks();
        }

        async function deletePreviousWork(workId) {
            await fetch(`http://localhost:8080/api/specialist/delete-previous-work/${workId}`, {
                method: "DELETE",
                headers: { "Authorization": `Bearer ${localStorage.getItem("token")}` }
            });
            fetchPreviousWorks();
        }

        async function acceptBooking(sessionId) {
            try {
                const response = await fetch(`http://localhost:8080/api/specialist/accept-booking/${sessionId}`, {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${localStorage.getItem("token")}`,
                        "Content-Type": "application/json"
                    }
                });

                const result = await response.json();
                if (response.ok) {
                    alert(result.message);
                    fetchBookings(); // Refresh the bookings list
                } else {
                    alert(result.error || "Failed to accept booking.");
                }
            } catch (error) {
                console.error("Error accepting booking:", error);
            }
        }

        async function rejectBooking(sessionId) {
            try {
                const response = await fetch(`http://localhost:8080/api/specialist/reject-booking/${sessionId}`, {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${localStorage.getItem("token")}`,
                        "Content-Type": "application/json"
                    }
                });

                const result = await response.json();
                if (response.ok) {
                    alert(result.message);
                    fetchBookings(); // Refresh the bookings list
                } else {
                    alert(result.error || "Failed to reject booking.");
                }
            } catch (error) {
                console.error("Error rejecting booking:", error);
            }
        }

        async function fetchUnreadMessagesCount() {
            try {
                const response = await fetch("http://localhost:8080/api/specialist/unread-messages-count", {
                    headers: { "Authorization": `Bearer ${localStorage.getItem("token")}` }
                });

                const data = await response.json();
                const unreadCount = document.getElementById("unreadCount");

                if (data.unreadCount > 0) {
                    unreadCount.textContent = data.unreadCount;
                    unreadCount.style.display = "block";
                } else {
                    unreadCount.style.display = "none";
                }
            } catch (error) {
                console.error("Error fetching unread messages count:", error);
            }
        }

        function openChatList() {
            const chatSection = document.getElementById("chats-section");

            if (!chatSection) {
                console.error("Chat section not found!");
                return;
            }

            showSection("chats-section"); // Ensure the chat section opens
            fetchChatList(); // Load the list of clients
        }

        function openChat(clientId, clientName) {
            document.getElementById("chatClientName").innerText = clientName;
            document.getElementById("chatClientName").dataset.clientId = clientId; // Store ID for sending messages
            document.getElementById("chatMessages").innerHTML = "<p>Loading messages...</p>";

            fetchMessages(clientId);
        }

        async function fetchChatList() {
            try {
                const response = await fetch("http://localhost:8080/api/specialist/chat-list", {
                    headers: { "Authorization": `Bearer ${localStorage.getItem("token")}` }
                });

                const data = await response.json();
                const chatList = document.getElementById("chatList");

                if (!chatList) {
                    console.error("Chat list element not found!");
                    return;
                }

                chatList.innerHTML = ""; // Clear previous list

                if (data.clients.length === 0) {
                    chatList.innerHTML = "<p>No chats available.</p>";
                }

                data.clients.forEach(client => {
                    const li = document.createElement("li");
                    li.textContent = client.full_name;
                    li.onclick = () => openChat(client.id, client.full_name);
                    chatList.appendChild(li);
                });

            } catch (error) {
                console.error("Error fetching chat list:", error);
            }
        }

        async function fetchMessages(clientId) {
            try {
                const response = await fetch(`http://localhost:8080/api/specialist/messages?other_user_id=${clientId}`, {
                    headers: { "Authorization": `Bearer ${localStorage.getItem("token")}` }
                });

                const data = await response.json();
                const chatMessages = document.getElementById("chatMessages");
                chatMessages.innerHTML = ""; // Clear existing messages

                if (data.messages.length === 0) {
                    chatMessages.innerHTML = "<p>No messages yet.</p>";
                }

                data.messages.forEach(msg => {
                    const msgDiv = document.createElement("div");
                    msgDiv.classList.add("message", msg.sender_id === clientId ? "received" : "sent");

                    // Format timestamp
                    const timestamp = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                    msgDiv.innerHTML = `
                        <span>${msg.message}</span>
                        <span class="timestamp">${timestamp}</span>
                    `;

                    chatMessages.appendChild(msgDiv);
                });

                // Auto-scroll to the latest message
                chatMessages.scrollTop = chatMessages.scrollHeight;

            } catch (error) {
                console.error("Error fetching messages:", error);
            }
        }

        async function sendMessage() {
            const message = document.getElementById("chatInput").value.trim();
            const receiverId = document.getElementById("chatClientName").dataset.clientId;

            if (!message) return; // Prevent sending empty messages

            try {
                const response = await fetch("http://localhost:8080/api/specialist/send-message", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${localStorage.getItem("token")}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ receiver_id: receiverId, message })
                });

                const result = await response.json();
                if (response.ok) {
                    document.getElementById("chatInput").value = "";
                    fetchMessages(receiverId); // Refresh chat
                } else {
                    alert(result.error || "Failed to send message.");
                }
            } catch (error) {
                console.error("Error sending message:", error);
            }
        }

        async function fetchReviews() {
            try {
                const response = await fetch("http://localhost:8080/api/specialist/reviews", {
                    headers: { "Authorization": `Bearer ${localStorage.getItem("token")}` }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const data = await response.json();
                const reviewsList = document.getElementById("reviewsList");
                const averageRatingSpan = document.getElementById("averageRating");

                // Clear previous reviews
                reviewsList.innerHTML = "";

                if (!data.reviews || data.reviews.length === 0) {
                    reviewsList.innerHTML = "<p>No reviews yet.</p>";
                    averageRatingSpan.innerText = "N/A";
                    return;
                }

                let totalRating = 0;

                // Loop through reviews and display them
                data.reviews.forEach(review => {
                    totalRating += review.rating;

                    const reviewCard = document.createElement("div");
                    reviewCard.classList.add("review-card");

                    // Create star rating display
                    let stars = '';
                    for (let i = 0; i < 5; i++) {
                        stars += i < review.rating ? '' : '';
                    }

                    reviewCard.innerHTML = `
                        <div class="review-header">
                            <span class="review-client">${review.client_name}</span>
                            <span class="review-rating">
                                <span class="star-rating">${stars}</span>
                                ${review.rating}/5
                            </span>
                        </div>
                        <div class="review-content">${review.review}</div>
                    `;

                    reviewsList.appendChild(reviewCard);
                });

                // Calculate and display the average rating
                const averageRating = (totalRating / data.reviews.length).toFixed(1);
                averageRatingSpan.innerHTML = `
                    <span class="star-rating">${''.repeat(Math.round(averageRating))}</span>
                    ${averageRating} (${data.reviews.length} reviews)
                `;

            } catch (error) {
                console.error("Error fetching reviews:", error);
                document.getElementById("reviewsList").innerHTML = `
                    <div class="error-message">
                        Error loading reviews. Please try again later.
                    </div>
                `;
            }
        }

        async function fetchAverageRating() {
            try {
                const response = await fetch("http://localhost:8080/api/specialist/average-rating", {
                    headers: { "Authorization": `Bearer ${localStorage.getItem("token")}` }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const data = await response.json();
                document.getElementById("averageRating").textContent = data.average_rating + " ";
            } catch (error) {
                console.error("Error fetching average rating:", error);
                document.getElementById("averageRating").textContent = "N/A";
            }
        }

        function logout() {
            // Add confirmation dialog
            if (confirm("Are you sure you want to logout?")) {
                localStorage.removeItem("token");
                window.location.href = "login.html";
            }
        }
        // Fetch reviews and average rating when the page loads
        document.addEventListener("DOMContentLoaded", () => {
            fetchReviews();
            fetchAverageRating();
            setInterval(fetchUnreadMessagesCount, 10000);
        });


        // Add these functions to specialist.html's script

        async function checkVerificationStatus() {
            try {
                const response = await fetch("http://localhost:8080/api/specialist/verification-status", {
                    headers: { "Authorization": `Bearer ${localStorage.getItem("token")}` }
                });

                const status = await response.json();
                const statusElement = document.getElementById("verification-status");

                if (status.status === "not_submitted") {
                    statusElement.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i> Your account is not verified. 
                    Please upload your documents for verification.
                </div>
            `;
                } else if (status.status === "pending") {
                    statusElement.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-clock"></i> Your verification is pending review by our team.
                </div>
            `;
                    document.getElementById("verification-form").style.display = "none";
                } else if (status.status === "approved") {
                    statusElement.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i> Your account has been verified!
                </div>
            `;
                    document.getElementById("verification-form").style.display = "none";
                } else if (status.status === "rejected") {
                    statusElement.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-times-circle"></i> Your verification was rejected.
                    ${status.rejection_reason ? `<p>Reason: ${status.rejection_reason}</p>` : ''}
                    Please correct the issues and resubmit.
                </div>
            `;
                }
            } catch (error) {
                console.error("Error checking verification status:", error);
            }
        }


        // Add to DOMContentLoaded:
        document.addEventListener("DOMContentLoaded", () => {
            // ... existing code ...
            checkVerificationStatus();
        });
        // Image preview function
        function previewImage(input, previewId) {
            const preview = document.getElementById(previewId);
            const file = input.files[0];

            if (file) {
                const reader = new FileReader();

                reader.onload = function (e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                }

                reader.readAsDataURL(file);
            } else {
                preview.src = '';
                preview.style.display = 'none';
            }
        }

        // In specialist.html
        async function submitVerification() {
            const frontImage = document.getElementById('front-image').files[0];
            const backImage = document.getElementById('back-image').files[0];

            if (!frontImage || !backImage) {
                alert('Please upload both front and back images');
                return;
            }

            const formData = new FormData();
            formData.append('front_image', frontImage);
            formData.append('back_image', backImage);

            try {
                const response = await fetch("http://localhost:8080/api/specialist/upload-verification", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${localStorage.getItem("token")}`
                        // Don't set Content-Type header for FormData - let the browser set it
                    },
                    body: formData
                });

                const result = await response.json();
                if (response.ok) {
                    alert(result.message);
                    // Update the previews with the uploaded images
                    document.getElementById('front-image-preview').src = result.frontImage;
                    document.getElementById('back-image-preview').src = result.backImage;
                    checkVerificationStatus();
                } else {
                    alert(result.error || "Failed to upload verification documents");
                }
            } catch (error) {
                console.error("Error uploading verification:", error);
                alert("Failed to upload verification documents");
            }
        }
        // Update checkVerificationStatus function
        async function checkVerificationStatus() {
            try {
                const response = await fetch("http://localhost:8080/api/specialist/verification-status", {
                    headers: { "Authorization": `Bearer ${localStorage.getItem("token")}` }
                });

                const status = await response.json();
                const statusElement = document.getElementById("verification-status");
                const formElement = document.getElementById("verification-form");

                if (status.status === "not_submitted") {
                    statusElement.innerHTML = `
                <i class="fas fa-exclamation-triangle"></i> Your account is not verified. 
                Please upload your documents for verification.
            `;
                    statusElement.className = "alert alert-warning";
                    formElement.style.display = "block";
                } else if (status.status === "pending") {
                    statusElement.innerHTML = `
                <i class="fas fa-clock"></i> Your verification is pending review by our team.
            `;
                    statusElement.className = "alert alert-info";
                    formElement.style.display = "none";
                } else if (status.status === "approved") {
                    statusElement.innerHTML = `
                <i class="fas fa-check-circle"></i> Your account has been verified!
            `;
                    statusElement.className = "alert alert-success";
                    formElement.style.display = "none";
                } else if (status.status === "rejected") {
                    statusElement.innerHTML = `
                <i class="fas fa-times-circle"></i> Your verification was rejected.
                ${status.rejection_reason ? `<p>Reason: ${status.rejection_reason}</p>` : ''}
                Please correct the issues and resubmit.
            `;
                    statusElement.className = "alert alert-danger";
                    formElement.style.display = "block";
                }
            } catch (error) {
                console.error("Error checking verification status:", error);
                document.getElementById("verification-status").innerHTML = `
            <i class="fas fa-exclamation-circle"></i> Error loading verification status
        `;
                document.getElementById("verification-status").className = "alert alert-danger";
            }
        } document.addEventListener("DOMContentLoaded", () => {
            showSection("view-profile");
            fetchSpecialistDetails();
            checkVerificationStatus(); // Add this line
            fetchReviews();
            fetchAverageRating();
            setInterval(fetchUnreadMessagesCount, 10000);
        });

        async function fetchSpecialistDetails() {
            try {
                // First fetch basic specialist details
                const detailsResponse = await fetch("http://localhost:8080/api/specialist/details", {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${localStorage.getItem("token")}`
                    }
                });

                const detailsResult = await detailsResponse.json();

                if (detailsResponse.ok) {
                    // Update basic profile information
                    document.getElementById("specialist-name").innerText = detailsResult.full_name;
                    document.getElementById("view-specialist-name").innerText = detailsResult.full_name;
                    document.getElementById("view-specialist-email").innerText = detailsResult.email;
                    document.getElementById("view-specialist-phone").innerText = detailsResult.phone;
                    document.getElementById("view-specialist-gender").innerText = detailsResult.gender;
                    document.getElementById("view-specialist-location").innerText = detailsResult.location;
                    document.getElementById("view-specialist-role").innerText = detailsResult.role;
                    document.getElementById("view-specialist-services").innerText = detailsResult.services || "Not set";
                    document.getElementById("view-specialist-experience").innerText = detailsResult.experience !== "Not set" ? `${detailsResult.experience} years` : "Not set";
                    document.getElementById("view-specialist-skills").innerText = detailsResult.skills || "Not set";

                    // Update profile photo if available
                    if (detailsResult.profile_photo) {
                        document.getElementById("profile-photo").src = detailsResult.profile_photo;
                        document.getElementById("view-profile-photo").src = detailsResult.profile_photo;
                    }

                    // Now fetch verification status separately
                    await updateVerificationStatusDisplay();
                } else {
                    alert(detailsResult.error || "Failed to load specialist details.");
                }
            } catch (error) {
                console.error("Error fetching specialist details:", error);
            }
        }

        // New dedicated function for updating verification status display
        async function updateVerificationStatusDisplay() {
            try {
                const response = await fetch("http://localhost:8080/api/specialist/verification-status-only", {
                    headers: { "Authorization": `Bearer ${localStorage.getItem("token")}` }
                });

                const statusData = await response.json();
                const statusElement = document.getElementById("view-specialist-status");
                const badgeElement = document.getElementById("verification-badge");

                // Clear previous status
                statusElement.className = "badge";
                badgeElement.style.display = "none";

                // Set status based on verification state
                switch (statusData.status) {
                    case 'approved':
                        statusElement.classList.add("badge-success");
                        statusElement.textContent = "Verified";
                        badgeElement.style.display = "inline";
                        break;

                    case 'pending':
                        statusElement.classList.add("badge-warning");
                        statusElement.textContent = "Pending Verification";
                        break;

                    case 'rejected':
                        statusElement.classList.add("badge-danger");
                        statusElement.textContent = statusData.rejection_reason
                            ? `Rejected: ${statusData.rejection_reason}`
                            : "Verification Rejected";
                        break;

                    default: // not_submitted
                        statusElement.classList.add("badge-danger");
                        statusElement.textContent = "Not Verified";
                }
            } catch (error) {
                console.error("Error updating verification status:", error);
                document.getElementById("view-specialist-status").innerHTML =
                    '<span class="badge badge-danger">Status Error</span>';
            }
        }

        // Update DOMContentLoaded
        document.addEventListener("DOMContentLoaded", () => {
            showSection("view-profile");
            fetchSpecialistDetails(); // This will handle both profile and verification status
            fetchReviews();
            fetchAverageRating();
            setInterval(fetchUnreadMessagesCount, 10000);
        });

        // Update DOMContentLoaded to remove the separate checkVerificationStatus call
        document.addEventListener("DOMContentLoaded", () => {
            showSection("view-profile");
            fetchSpecialistDetails();
            fetchReviews();
            fetchAverageRating();
            setInterval(fetchUnreadMessagesCount, 10000);
        });
    </script>
</body>

</html>